AWSTemplateFormatVersion: '2010-09-09'
Transform: AWS::Serverless-2016-10-31
Description: IoT Devices Stack - Parking Simulator
Resources:
  ParkingIoTPolicy:
    Type: AWS::IoT::Policy
    Properties:
      PolicyDocument:
        Version: '2012-10-17'
        Statement:
        - Effect: Allow
          Action:
          - iot:Connect
          - iot:Publish
          - iot:Subscribe
          - iot:Receive
          Resource: '*'
  ParkingIoTRule:
    Type: AWS::IoT::TopicRule
    Properties:
      RuleName: parkingStatusRule
      TopicRulePayload:
        Sql: SELECT * FROM 'parking/+/status'
        AwsIotSqlVersion: '2016-03-23'
        Actions:
        - Lambda:
            FunctionArn:
              Fn::GetAtt:
              - IoTIngestionFunction
              - Arn
        RuleDisabled: false
  IoTIngestionFunction:
    Type: AWS::Serverless::Function
    Properties:
      CodeUri: IoTIngestionFunction
      Handler: index.handler
      Runtime: nodejs20.x
      Timeout: 5
    Metadata:
      SamResourceId: IoTIngestionFunction
Outputs:
  IoTPolicyName:
    Description: IoT Policy for devices
    Value:
      Ref: ParkingIoTPolicy
  IoTRuleName:
    Description: IoT Rule for parking events
    Value:
      Ref: ParkingIoTRule
